---
id: T-remove-system-rules
title: Remove system rules extraction from MCP prompts implementation
status: done
priority: high
parent: none
prerequisites: []
affectedFiles:
  src/prompts/TrellisPrompt.ts: Removed systemRules field from TrellisPrompt interface
  src/prompts/PromptParser.ts: Removed extractSystemRules function and updated
    parsePromptFile and buildPromptData to pass body content directly without
    extraction
  src/prompts/PromptRenderer.ts: Removed system message logic, now only returns user messages
  src/prompts/__tests__/PromptParser.test.ts: Updated tests to expect <rules>
    content to remain inline in userTemplate instead of being extracted
  src/prompts/__tests__/PromptRenderer.test.ts:
    Updated tests to expect only user
    messages and verify <rules> content remains inline
  src/prompts/__tests__/TrellisPrompt.test.ts: Removed tests for systemRules field that no longer exists
log:
  - Successfully removed system rules extraction functionality from MCP prompts
    implementation. All `<rules>` content now remains inline in user messages
    instead of being extracted into separate system messages. This ensures
    compatibility with ClaudeCode which expects rules to be inline.
schema: v1.0
childrenIds: []
created: 2025-09-03T00:12:03.594Z
updated: 2025-09-03T00:12:03.594Z
---

# Remove System Rules Extraction from MCP Prompts Implementation

## Context

The current MCP prompts implementation extracts rules from prompt content within `<rules>...</rules>` tags and attempts to push them as separate system messages. However, ClaudeCode doesn't support this syntax and just returns the prompt as-is. This functionality needs to be completely removed so that rules remain inline within the user message content.

## Problem

Currently, the system:

1. Extracts content from `<rules>...</rules>` tags using `extractSystemRules()` function
2. Stores extracted rules in `TrellisPrompt.systemRules` field
3. Removes rules from the original content ("cleans" it)
4. Pushes rules as separate system messages in the renderer
5. ClaudeCode ignores this and just returns the original prompt

## Solution

Remove all system rules extraction functionality and ensure rules stay inline in prompts.

## Detailed Implementation Requirements

### 1. Update TrellisPrompt Interface

**File: `src/prompts/TrellisPrompt.ts`**

- Remove the `systemRules?: string;` field from the `TrellisPrompt` interface
- Update JSDoc comments to remove references to system rules extraction

### 2. Modify PromptParser

**File: `src/prompts/PromptParser.ts`**

- Remove the `extractSystemRules()` function entirely (lines 42-66)
- Update `parsePromptFile()` function to:
  - Remove the call to `extractSystemRules(body)`
  - Pass the original `body` content directly to `buildPromptData()` without cleaning
- Update `buildPromptData()` function to:
  - Remove the `systemRules` parameter
  - Remove the `systemRules` field assignment in the returned object

### 3. Update PromptRenderer

**File: `src/prompts/PromptRenderer.ts`**

- Remove the system message logic from `renderPrompt()` method:
  ```typescript
  // Remove this block entirely:
  if (prompt.systemRules) {
    messages.push({
      role: "system",
      content: { type: "text", text: prompt.systemRules },
    });
  }
  ```
- Ensure only user messages are returned

### 4. Update Test Files

**Files: `src/prompts/__tests__/*.test.ts`**

- **TrellisPrompt.test.ts**: Remove all tests related to `systemRules` field
- **PromptParser.test.ts**:
  - Remove tests for `extractSystemRules()` function
  - Remove tests expecting system rules to be extracted from content
  - Update tests to expect `<rules>` content to remain in the user template
- **PromptRenderer.test.ts**:
  - Remove tests expecting system messages to be generated
  - Update tests to expect only user messages in output
  - Add tests confirming `<rules>` content remains in user message

## Acceptance Criteria

### Functional Requirements

- [ ] `<rules>` content remains in the original prompt content (not extracted)
- [ ] No system messages are generated by the renderer
- [ ] Only user messages are returned from `renderPrompt()`
- [ ] All existing prompt files continue to work with rules inline
- [ ] MCP prompts API returns only user messages with complete content

### Code Quality Requirements

- [ ] `TrellisPrompt` interface no longer has `systemRules` field
- [ ] `extractSystemRules()` function is completely removed
- [ ] All references to system rules extraction are removed from code
- [ ] All related tests are updated or removed
- [ ] Type safety is maintained throughout the prompts system

### Testing Requirements

- [ ] All existing unit tests pass with updated expectations
- [ ] New tests confirm `<rules>` content stays in user messages
- [ ] Integration tests verify MCP API behavior is correct
- [ ] No system messages are generated in any test scenarios

## Technical Approach

1. **Start with interface changes** - Remove `systemRules` from `TrellisPrompt` to catch all usage
2. **Update parser logic** - Remove extraction and cleaning functions
3. **Simplify renderer** - Remove system message generation
4. **Fix tests systematically** - Update all test expectations
5. **Verify with existing prompts** - Ensure no regressions

## Security Considerations

- Ensure prompt content validation still works correctly
- Verify no injection vulnerabilities are introduced
- Maintain input sanitization in renderer

## Dependencies

None - this is a standalone refactoring task.

## Out of Scope

- Do not modify existing prompt files in `prompts/basic/` directory
- Do not change the MCP API interface structure
- Do not alter argument handling or template substitution logic
- Do not modify the PromptManager class loading logic
